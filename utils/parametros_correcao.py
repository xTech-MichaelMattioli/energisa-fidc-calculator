"""
Parâmetros de correção monetária para o cálculo FIDC
Baseado no notebook original
"""

import json
import pandas as pd
import sidrapy
from datetime import datetime
from typing import Dict


class ParametrosCorrecao:
    """
    Parâmetros específicos para correção monetária,
    utilizando IGP-M até 2021.05 e IPCA a partir de 2021.06.
    """

    def __init__(self, valor_base_ipca: float = 1069.29):
        # PARÂMETROS FINANCEIROS
        self.taxa_multa = 0.02           # 2% de multa
        self.taxa_juros_mensal = 0.01    # 1% ao mês

        # DATA DE REFERÊNCIA PADRÃO (pode ser ajustada por distribuidora)
        self.data_base_padrao = datetime(2025, 4, 30)

        # ARMAZENAMENTO DE ÍNDICES
        self.indices_igpm = self._carregar_igpm()
        self.indices_ipca = self._calcular_ipca_acumulado(valor_base_ipca)

    def _carregar_igpm(self):
        """Carrega os índices IGP-M acumulados até 2021.05."""

        return {
            "1994.08": 100.0,
            "1994.09": 101.75,
            "1994.10": 103.6,
            "1994.11": 106.55,
            "1994.12": 107.45,
            "1995.01": 108.44,
            "1995.02": 109.95,
            "1995.03": 111.18,
            "1995.04": 113.52,
            "1995.05": 114.17,
            "1995.06": 116.98,
            "1995.07": 119.11,
            "1995.08": 121.73,
            "1995.09": 120.87,
            "1995.10": 121.5,
            "1995.11": 122.96,
            "1995.12": 123.83,
            "1996.01": 125.98,
            "1996.02": 127.2,
            "1996.03": 127.72,
            "1996.04": 128.13,
            "1996.05": 130.12,
            "1996.06": 131.45,
            "1996.07": 133.21,
            "1996.08": 133.59,
            "1996.09": 133.72,
            "1996.10": 133.98,
            "1996.11": 134.24,
            "1996.12": 135.23,
            "1997.01": 137.61,
            "1997.02": 138.2,
            "1997.03": 139.8,
            "1997.04": 140.74,
            "1997.05": 141.04,
            "1997.06": 142.09,
            "1997.07": 142.22,
            "1997.08": 142.35,
            "1997.09": 143.04,
            "1997.10": 143.57,
            "1997.11": 144.48,
            "1997.12": 145.7,
            "1998.01": 147.09,
            "1998.02": 147.36,
            "1998.03": 147.64,
            "1998.04": 147.82,
            "1998.05": 148.02,
            "1998.06": 148.59,
            "1998.07": 148.34,
            "1998.08": 148.11,
            "1998.09": 147.98,
            "1998.10": 148.1,
            "1998.11": 147.63,
            "1998.12": 148.29,
            "1999.01": 149.53,
            "1999.02": 154.93,
            "1999.03": 159.33,
            "1999.04": 160.46,
            "1999.05": 160.0,
            "1999.06": 160.57,
            "1999.07": 163.06,
            "1999.08": 165.6,
            "1999.09": 168.0,
            "1999.10": 170.86,
            "1999.11": 174.94,
            "1999.12": 178.1,
            "2000.01": 180.3,
            "2000.02": 180.94,
            "2000.03": 181.21,
            "2000.04": 181.64,
            "2000.05": 182.19,
            "2000.06": 183.75,
            "2000.07": 186.63,
            "2000.08": 191.09,
            "2000.09": 193.3,
            "2000.10": 194.04,
            "2000.11": 194.6,
            "2000.12": 195.83,
            "2001.01": 197.05,
            "2001.02": 197.49,
            "2001.03": 198.61,
            "2001.04": 200.59,
            "2001.05": 202.32,
            "2001.06": 204.31,
            "2001.07": 207.34,
            "2001.08": 210.21,
            "2001.09": 210.85,
            "2001.10": 213.34,
            "2001.11": 215.69,
            "2001.12": 216.16,
            "2002.01": 216.94,
            "2002.02": 217.07,
            "2002.03": 217.28,
            "2002.04": 218.49,
            "2002.05": 220.29,
            "2002.06": 223.69,
            "2002.07": 228.06,
            "2002.08": 233.35,
            "2002.09": 238.94,
            "2002.10": 248.2,
            "2002.11": 261.08,
            "2002.12": 270.87,
            "2003.01": 277.17,
            "2003.02": 283.51,
            "2003.03": 287.86,
            "2003.04": 290.51,
            "2003.05": 289.75,
            "2003.06": 286.84,
            "2003.07": 285.65,
            "2003.08": 286.74,
            "2003.09": 290.13,
            "2003.10": 291.23,
            "2003.11": 292.66,
            "2003.12": 294.46,
            "2004.01": 297.04,
            "2004.02": 299.1,
            "2004.03": 302.48,
            "2004.04": 306.15,
            "2004.05": 310.15,
            "2004.06": 314.42,
            "2004.07": 318.53,
            "2004.08": 322.41,
            "2004.09": 324.65,
            "2004.10": 325.93,
            "2004.11": 328.59,
            "2004.12": 331.01,
            "2005.01": 332.3,
            "2005.02": 333.29,
            "2005.03": 336.12,
            "2005.04": 339.03,
            "2005.05": 338.3,
            "2005.06": 336.8,
            "2005.07": 335.66,
            "2005.08": 333.47,
            "2005.09": 331.69,
            "2005.10": 333.69,
            "2005.11": 335.03,
            "2005.12": 335.01,
            "2006.01": 338.08,
            "2006.02": 338.13,
            "2006.03": 337.34,
            "2006.04": 335.92,
            "2006.05": 337.19,
            "2006.06": 339.71,
            "2006.07": 340.31,
            "2006.08": 341.57,
            "2006.09": 342.56,
            "2006.10": 344.16,
            "2006.11": 346.75,
            "2006.12": 347.84,
            "2007.01": 349.59,
            "2007.02": 350.52,
            "2007.03": 351.72,
            "2007.04": 351.87,
            "2007.05": 352.02,
            "2007.06": 352.94,
            "2007.07": 353.92,
            "2007.08": 357.4,
            "2007.09": 362.0,
            "2007.10": 365.79,
            "2007.11": 368.33,
            "2007.12": 374.82,
            "2008.01": 378.9,
            "2008.02": 380.91,
            "2008.03": 383.73,
            "2008.04": 386.38,
            "2008.05": 392.59,
            "2008.06": 400.38,
            "2008.07": 407.45,
            "2008.08": 406.13,
            "2008.09": 406.56,
            "2008.10": 410.52,
            "2008.11": 412.1,
            "2008.12": 411.58,
            "2009.01": 409.78,
            "2009.02": 410.85,
            "2009.03": 407.81,
            "2009.04": 407.18,
            "2009.05": 406.89,
            "2009.06": 406.49,
            "2009.07": 404.72,
            "2009.08": 403.25,
            "2009.09": 404.95,
            "2009.10": 405.13,
            "2009.11": 405.55,
            "2009.12": 404.5,
            "2010.01": 407.05,
            "2010.02": 411.84,
            "2010.03": 415.73,
            "2010.04": 418.92,
            "2010.05": 423.89,
            "2010.06": 427.49,
            "2010.07": 428.15,
            "2010.08": 431.45,
            "2010.09": 436.42,
            "2010.10": 440.83,
            "2010.11": 447.21,
            "2010.12": 450.3,
            "2011.01": 453.88,
            "2011.02": 458.4,
            "2011.03": 461.25,
            "2011.04": 463.31,
            "2011.05": 465.31,
            "2011.06": 464.46,
            "2011.07": 463.93,
            "2011.08": 465.97,
            "2011.09": 468.98,
            "2011.10": 471.47,
            "2011.11": 473.81,
            "2011.12": 473.25,
            "2012.01": 474.43,
            "2012.02": 474.14,
            "2012.03": 476.17,
            "2012.04": 480.23,
            "2012.05": 485.14,
            "2012.06": 488.34,
            "2012.07": 494.89,
            "2012.08": 501.96,
            "2012.09": 506.8,
            "2012.10": 506.93,
            "2012.11": 506.8,
            "2012.12": 510.25,
            "2013.01": 511.98,
            "2013.02": 513.47,
            "2013.03": 514.53,
            "2013.04": 515.28,
            "2013.05": 515.3,
            "2013.06": 519.15,
            "2013.07": 520.51,
            "2013.08": 521.27,
            "2013.09": 529.09,
            "2013.10": 533.62,
            "2013.11": 535.17,
            "2013.12": 538.37,
            "2014.01": 540.96,
            "2014.02": 543.04,
            "2014.03": 552.09,
            "2014.04": 556.42,
            "2014.05": 555.68,
            "2014.06": 551.55,
            "2014.07": 548.2,
            "2014.08": 546.75,
            "2014.09": 547.84,
            "2014.10": 549.4,
            "2014.11": 554.77,
            "2014.12": 558.21,
            "2015.01": 562.48,
            "2015.02": 564.0,
            "2015.03": 569.54,
            "2015.04": 576.18,
            "2015.05": 578.52,
            "2015.06": 582.4,
            "2015.07": 586.43,
            "2015.08": 588.04,
            "2015.09": 593.61,
            "2015.10": 604.83,
            "2015.11": 614.05,
            "2015.12": 617.04,
            "2016.01": 624.06,
            "2016.02": 632.11,
            "2016.03": 635.35,
            "2016.04": 637.43,
            "2016.05": 642.65,
            "2016.06": 653.5,
            "2016.07": 654.64,
            "2016.08": 655.6,
            "2016.09": 656.89,
            "2016.10": 657.93,
            "2016.11": 657.75,
            "2016.12": 661.3,
            "2017.01": 665.54,
            "2017.02": 666.1,
            "2017.03": 666.2,
            "2017.04": 658.9,
            "2017.05": 652.76,
            "2017.06": 648.41,
            "2017.07": 643.77,
            "2017.08": 644.38,
            "2017.09": 647.4,
            "2017.10": 648.67,
            "2017.11": 652.07,
            "2017.12": 657.86,
            "2018.01": 662.83,
            "2018.02": 663.31,
            "2018.03": 667.52,
            "2018.04": 671.33,
            "2018.05": 680.58,
            "2018.06": 693.29,
            "2018.07": 696.8,
            "2018.08": 701.68,
            "2018.09": 712.37,
            "2018.10": 718.68,
            "2018.11": 715.17,
            "2018.12": 707.44,
            "2019.01": 707.49,
            "2019.02": 713.75,
            "2019.03": 722.71,
            "2019.04": 729.35,
            "2019.05": 732.6,
            "2019.06": 738.42,
            "2019.07": 741.35,
            "2019.08": 736.4,
            "2019.09": 736.36,
            "2019.10": 741.33,
            "2019.11": 743.56,
            "2019.12": 759.11,
            "2020.01": 762.73,
            "2020.02": 762.42,
            "2020.03": 771.91,
            "2020.04": 778.1,
            "2020.05": 780.28,
            "2020.06": 792.43,
            "2020.07": 810.08,
            "2020.08": 832.31,
            "2020.09": 868.44,
            "2020.10": 896.51,
            "2020.11": 925.89,
            "2020.12": 934.76,
            "2021.01": 958.84,
            "2021.02": 983.06,
            "2021.03": 1011.95,
            "2021.04": 1027.21,
            "2021.05": 1069.29
            }

    def _calcular_ipca_acumulado(self, valor_inicial: float):
        """Baixa IPCA mensal e calcula índice acumulado a partir de 2021.06."""
        try:
            start = "202106"
            end = datetime.today().strftime("%Y%m")
            periodo = f"{start}-{end}"

            df = sidrapy.get_table(
                table_code="1737",
                territorial_level="1",
                ibge_territorial_code="all",
                variable="63",
                period=periodo,
                format="pandas"
            )[['D2C', 'V']][1:]

            df["V"] = df["V"].astype(float)

            acumulado = [valor_inicial]
            for i in range(1, len(df)):
                novo_valor = round(acumulado[-1] * (1 + df.loc[i, "V"] / 100), 4)
                acumulado.append(novo_valor)

            df["acumulado"] = acumulado

            ipca_dict = {
                f"{str(row['D2C'])[:4]}.{str(row['D2C'])[4:]}": row["acumulado"]
                for _, row in df.iterrows()
            }

            return ipca_dict
        
        except Exception:
            # Dados IPCA padrão caso API não funcione
            return {
                "2021.07": 1078.02, "2021.08": 1086.41, "2021.09": 1096.87,
                "2021.10": 1107.98, "2021.11": 1119.53, "2021.12": 1130.95, "2022.01": 1142.76,
                "2022.02": 1154.36, "2022.03": 1166.03, "2022.04": 1177.75, "2022.05": 1190.70,
                "2022.06": 1202.69, "2022.07": 1210.44, "2022.08": 1209.64, "2022.09": 1215.85,
                "2022.10": 1222.74, "2022.11": 1228.50, "2022.12": 1234.63, "2023.01": 1241.52,
                "2023.02": 1248.99, "2023.03": 1257.24, "2023.04": 1263.73, "2023.05": 1267.85,
                "2023.06": 1268.06, "2023.07": 1268.91, "2023.08": 1270.23, "2023.09": 1271.96,
                "2023.10": 1273.51, "2023.11": 1274.15, "2023.12": 1276.05, "2024.01": 1279.38,
                "2024.02": 1283.86, "2024.03": 1289.02, "2024.04": 1293.40, "2024.05": 1296.85,
                "2024.06": 1300.47, "2024.07": 1304.94, "2024.08": 1308.67, "2024.09": 1312.83,
                "2024.10": 1316.78, "2024.11": 1320.84, "2024.12": 1325.18, "2025.01": 1329.46
            }

    def buscar_indice_correcao(self, data: datetime) -> float:
        """Retorna o índice de correção (IGPM ou IPCA) para a data especificada."""
        ref = f"{data.year}.{data.month:02d}"
        if ref <= "2021.05":
            return float(self.indices_igpm.get(ref, 624.40))
        else:
            return float(self.indices_ipca.get(ref, 1329.46))

    def exibir_parametros(self):
        """Exibe os parâmetros atuais."""
        return {
            'taxa_multa': f"{self.taxa_multa:.2%}",
            'taxa_juros': f"{self.taxa_juros_mensal:.2%} ao mês"
        }
