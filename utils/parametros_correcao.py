"""
Parâmetros de correção monetária para o cálculo FIDC
Baseado no notebook original
"""

import json
import pandas as pd
import sidrapy
from datetime import datetime
from typing import Dict


class ParametrosCorrecao:
    """
    Parâmetros específicos para correção monetária,
    utilizando IGP-M até 2021.05 e IPCA a partir de 2021.06.
    """

    def __init__(self, valor_base_ipca: float = 1069.29):
        # PARÂMETROS FINANCEIROS
        self.taxa_multa = 0.02           # 2% de multa
        self.taxa_juros_mensal = 0.01    # 1% ao mês

        # DATA DE REFERÊNCIA PADRÃO (pode ser ajustada por distribuidora)
        self.data_base_padrao = datetime(2025, 4, 30)

        # ARMAZENAMENTO DE ÍNDICES
        self.indices_igpm = self._carregar_igpm()
        self.indices_ipca = self._calcular_ipca_acumulado(valor_base_ipca)

    def _carregar_igpm(self):
        """Carrega os índices IGP-M acumulados até 2021.05."""

        return {
            "1994.08": 100.00000,
            "1994.09": 101.75100,
            "1994.10": 103.60200,
            "1994.11": 106.55300,
            "1994.12": 107.45000,
            "1995.01": 108.44200,
            "1995.02": 109.94500,
            "1995.03": 111.17800,
            "1995.04": 113.51800,
            "1995.05": 114.17100,
            "1995.06": 116.98400,
            "1995.07": 119.11400,
            "1995.08": 121.72900,
            "1995.09": 120.86900,
            "1995.10": 121.50300,
            "1995.11": 122.95500,
            "1995.12": 123.83300,
            "1996.01": 125.97700,
            "1996.02": 127.20200,
            "1996.03": 127.71500,
            "1996.04": 128.13000,
            "1996.05": 130.12100,
            "1996.06": 131.44500,
            "1996.07": 133.21300,
            "1996.08": 133.58700,
            "1996.09": 133.72200,
            "1996.10": 133.97800,
            "1996.11": 134.24200,
            "1996.12": 135.22500,
            "1997.01": 137.61300,
            "1997.02": 138.20400,
            "1997.03": 139.79500,
            "1997.04": 140.74200,
            "1997.05": 141.04000,
            "1997.06": 142.09000,
            "1997.07": 142.22100,
            "1997.08": 142.35300,
            "1997.09": 143.04200,
            "1997.10": 143.56700,
            "1997.11": 144.48100,
            "1997.12": 145.69500,
            "1998.01": 147.09100,
            "1998.02": 147.35600,
            "1998.03": 147.63500,
            "1998.04": 147.82100,
            "1998.05": 148.02100,
            "1998.06": 148.58800,
            "1998.07": 148.33900,
            "1998.08": 148.10900,
            "1998.09": 147.98400,
            "1998.10": 148.10000,
            "1998.11": 147.62800,
            "1998.12": 148.29100,
            "1999.01": 149.53300,
            "1999.02": 154.93300,
            "1999.03": 159.32500,
            "1999.04": 160.45900,
            "1999.05": 159.99600,
            "1999.06": 160.57300,
            "1999.07": 163.06000,
            "1999.08": 165.60300,
            "1999.09": 167.99700,
            "1999.10": 170.86100,
            "1999.11": 174.93900,
            "1999.12": 178.09900,
            "2000.01": 180.30100,
            "2000.02": 180.93500,
            "2000.03": 181.21400,
            "2000.04": 181.63500,
            "2000.05": 182.18900,
            "2000.06": 183.74500,
            "2000.07": 186.63400,
            "2000.08": 191.08700,
            "2000.09": 193.29700,
            "2000.10": 194.04000,
            "2000.11": 194.59900,
            "2000.12": 195.82700,
            "2001.01": 197.04500,
            "2001.02": 197.49100,
            "2001.03": 198.60600,
            "2001.04": 200.59100,
            "2001.05": 202.32400,
            "2001.06": 204.31000,
            "2001.07": 207.34100,
            "2001.08": 210.21100,
            "2001.09": 210.85300,
            "2001.10": 213.33900,
            "2001.11": 215.68500,
            "2001.12": 216.16300,
            "2002.01": 216.94400,
            "2002.02": 217.07400,
            "2002.03": 217.27600,
            "2002.04": 218.48600,
            "2002.05": 220.29200,
            "2002.06": 223.68800,
            "2002.07": 228.05700,
            "2002.08": 233.34800,
            "2002.09": 238.94300,
            "2002.10": 248.19900,
            "2002.11": 261.08000,
            "2002.12": 270.86700,
            "2003.01": 277.17300,
            "2003.02": 283.50600,
            "2003.03": 287.85500,
            "2003.04": 290.51200,
            "2003.05": 289.74700,
            "2003.06": 286.84300,
            "2003.07": 285.64900,
            "2003.08": 286.73500,
            "2003.09": 290.12700,
            "2003.10": 291.22900,
            "2003.11": 292.65700,
            "2003.12": 294.45500,
            "2004.01": 297.03900,
            "2004.02": 299.09700,
            "2004.03": 302.48400,
            "2004.04": 306.15100,
            "2004.05": 310.15200,
            "2004.06": 314.41900,
            "2004.07": 318.53200,
            "2004.08": 322.41200,
            "2004.09": 324.65100,
            "2004.10": 325.92500,
            "2004.11": 328.58800,
            "2004.12": 331.00500,
            "2005.01": 332.29800,
            "2005.02": 333.28800,
            "2005.03": 336.12300,
            "2005.04": 339.03000,
            "2005.05": 338.29900,
            "2005.06": 336.80100,
            "2005.07": 335.66300,
            "2005.08": 333.47400,
            "2005.09": 331.69000,
            "2005.10": 333.69400,
            "2005.11": 335.03300,
            "2005.12": 335.00600,
            "2006.01": 338.08300,
            "2006.02": 338.12800,
            "2006.03": 337.33900,
            "2006.04": 335.92100,
            "2006.05": 337.18500,
            "2006.06": 339.71200,
            "2006.07": 340.31200,
            "2006.08": 341.57400,
            "2006.09": 342.56100,
            "2006.10": 344.15500,
            "2006.11": 346.74600,
            "2006.12": 347.84200,
            "2007.01": 349.59300,
            "2007.02": 350.52400,
            "2007.03": 351.71700,
            "2007.04": 351.86900,
            "2007.05": 352.02000,
            "2007.06": 352.93600,
            "2007.07": 353.92000,
            "2007.08": 357.40400,
            "2007.09": 361.99700,
            "2007.10": 365.79400,
            "2007.11": 368.33400,
            "2007.12": 374.81500,
            "2008.01": 378.90000,
            "2008.02": 380.90600,
            "2008.03": 383.73100,
            "2008.04": 386.38000,
            "2008.05": 392.59200,
            "2008.06": 400.38200,
            "2008.07": 407.44600,
            "2008.08": 406.12700,
            "2008.09": 406.55700,
            "2008.10": 410.52400,
            "2008.11": 412.10400,
            "2008.12": 411.57500,
            "2009.01": 409.78200,
            "2009.02": 410.84900,
            "2009.03": 407.80800,
            "2009.04": 407.18100,
            "2009.05": 406.88500,
            "2009.06": 406.48600,
            "2009.07": 404.71800,
            "2009.08": 403.25300,
            "2009.09": 404.94500,
            "2009.10": 405.12900,
            "2009.11": 405.54800,
            "2009.12": 404.49900,
            "2010.01": 407.04900,
            "2010.02": 411.84300,
            "2010.03": 415.73400,
            "2010.04": 418.91700,
            "2010.05": 423.88500,
            "2010.06": 427.48900,
            "2010.07": 428.15000,
            "2010.08": 431.44500,
            "2010.09": 436.42300,
            "2010.10": 440.82900,
            "2010.11": 447.20600,
            "2010.12": 450.30100,
            "2011.01": 453.87500,
            "2011.02": 458.39700,
            "2011.03": 461.24900,
            "2011.04": 463.31100,
            "2011.05": 465.31100,
            "2011.06": 464.46300,
            "2011.07": 463.92700,
            "2011.08": 465.96800,
            "2011.09": 468.97500,
            "2011.10": 471.46600,
            "2011.11": 473.80800,
            "2011.12": 473.25200,
            "2012.01": 474.42900,
            "2012.02": 474.13800,
            "2012.03": 476.16600,
            "2012.04": 480.22900,
            "2012.05": 485.14000,
            "2012.06": 488.34200,
            "2012.07": 494.89100,
            "2012.08": 501.95700,
            "2012.09": 506.80400,
            "2012.10": 506.92600,
            "2012.11": 506.79500,
            "2012.12": 510.25200,
            "2013.01": 511.97700,
            "2013.02": 513.46700,
            "2013.03": 514.52600,
            "2013.04": 515.27600,
            "2013.05": 515.29900,
            "2013.06": 519.15300,
            "2013.07": 520.50800,
            "2013.08": 521.27000,
            "2013.09": 529.08500,
            "2013.10": 533.62100,
            "2013.11": 535.16800,
            "2013.12": 538.37000,
            "2014.01": 540.95900,
            "2014.02": 543.03800,
            "2014.03": 552.08700,
            "2014.04": 556.42000,
            "2014.05": 555.67900,
            "2014.06": 551.55400,
            "2014.07": 548.20200,
            "2014.08": 546.74500,
            "2014.09": 547.83900,
            "2014.10": 549.39600,
            "2014.11": 554.76900,
            "2014.12": 558.21300,
            "2015.01": 562.48200,
            "2015.02": 564.00400,
            "2015.03": 569.53600,
            "2015.04": 576.17500,
            "2015.05": 578.51600,
            "2015.06": 582.40100,
            "2015.07": 586.42600,
            "2015.08": 588.04200,
            "2015.09": 593.60600,
            "2015.10": 604.83200,
            "2015.11": 614.05100,
            "2015.12": 617.04400,
            "2016.01": 624.06000,
            "2016.02": 632.11400,
            "2016.03": 635.34900,
            "2016.04": 637.43400,
            "2016.05": 642.65100,
            "2016.06": 653.49600,
            "2016.07": 654.64100,
            "2016.08": 655.60200,
            "2016.09": 656.89400,
            "2016.10": 657.92700,
            "2016.11": 657.75200,
            "2016.12": 661.30400,
            "2017.01": 665.54200,
            "2017.02": 666.09900,
            "2017.03": 666.19700,
            "2017.04": 658.89800,
            "2017.05": 652.75800,
            "2017.06": 648.40900,
            "2017.07": 643.76600,
            "2017.08": 644.38300,
            "2017.09": 647.40000,
            "2017.10": 648.67200,
            "2017.11": 652.07300,
            "2017.12": 657.85900,
            "2018.01": 662.82600,
            "2018.02": 663.31100,
            "2018.03": 667.52400,
            "2018.04": 671.32700,
            "2018.05": 680.57900,
            "2018.06": 693.28700,
            "2018.07": 696.80000,
            "2018.08": 701.67700,
            "2018.09": 712.37300,
            "2018.10": 718.68400,
            "2018.11": 715.16600,
            "2018.12": 707.44100,
            "2019.01": 707.48800,
            "2019.02": 713.74700,
            "2019.03": 722.70700,
            "2019.04": 729.34600,
            "2019.05": 732.59500,
            "2019.06": 738.42100,
            "2019.07": 741.34600,
            "2019.08": 736.40200,
            "2019.09": 736.36200,
            "2019.10": 741.33300,
            "2019.11": 743.55800,
            "2019.12": 759.11200,
            "2020.01": 762.73300,
            "2020.02": 762.42300,
            "2020.03": 771.90800,
            "2020.04": 778.10100,
            "2020.05": 780.28000,
            "2020.06": 792.42900,
            "2020.07": 810.08300,
            "2020.08": 832.31300,
            "2020.09": 868.44200,
            "2020.10": 896.50500,
            "2020.11": 925.88700,
            "2020.12": 934.75800,
            "2021.01": 958.84400,
            "2021.02": 983.06300,
            "2021.03": 1011.94800,
            "2021.04": 1027.21100,
            "2021.05": 1069.28900
            }

    def _calcular_ipca_acumulado(self, valor_inicial: float):
        """Baixa IPCA mensal e calcula índice acumulado a partir de 2021.06."""
        try:
            start = "202106"
            end = datetime.today().strftime("%Y%m")
            periodo = f"{start}-{end}"

            df = sidrapy.get_table(
                table_code="1737",
                territorial_level="1",
                ibge_territorial_code="all",
                variable="63",
                period=periodo,
                format="pandas"
            )[['D2C', 'V']][1:]

            df["V"] = df["V"].astype(float)

            acumulado = [valor_inicial]
            for i in range(1, len(df)):
                novo_valor = round(acumulado[-1] * (1 + df.loc[i, "V"] / 100), 4)
                acumulado.append(novo_valor)

            df["acumulado"] = acumulado

            ipca_dict = {
                f"{str(row['D2C'])[:4]}.{str(row['D2C'])[4:]}": row["acumulado"]
                for _, row in df.iterrows()
            }

            return ipca_dict
        
        except Exception:
            # Dados IPCA padrão caso API não funcione
            return {
                "2021.07": 1078.02, "2021.08": 1086.41, "2021.09": 1096.87,
                "2021.10": 1107.98, "2021.11": 1119.53, "2021.12": 1130.95, "2022.01": 1142.76,
                "2022.02": 1154.36, "2022.03": 1166.03, "2022.04": 1177.75, "2022.05": 1190.70,
                "2022.06": 1202.69, "2022.07": 1210.44, "2022.08": 1209.64, "2022.09": 1215.85,
                "2022.10": 1222.74, "2022.11": 1228.50, "2022.12": 1234.63, "2023.01": 1241.52,
                "2023.02": 1248.99, "2023.03": 1257.24, "2023.04": 1263.73, "2023.05": 1267.85,
                "2023.06": 1268.06, "2023.07": 1268.91, "2023.08": 1270.23, "2023.09": 1271.96,
                "2023.10": 1273.51, "2023.11": 1274.15, "2023.12": 1276.05, "2024.01": 1279.38,
                "2024.02": 1283.86, "2024.03": 1289.02, "2024.04": 1293.40, "2024.05": 1296.85,
                "2024.06": 1300.47, "2024.07": 1304.94, "2024.08": 1308.67, "2024.09": 1312.83,
                "2024.10": 1316.78, "2024.11": 1320.84, "2024.12": 1325.18, "2025.01": 1329.46
            }

    def buscar_indice_correcao(self, data: datetime) -> float:
        """Retorna o índice de correção (IGPM ou IPCA) para a data especificada."""
        ref = f"{data.year}.{data.month:02d}"
        if ref <= "2021.05":
            return float(self.indices_igpm.get(ref, 624.40))
        else:
            return float(self.indices_ipca.get(ref, 1329.46))

    def exibir_parametros(self):
        """Exibe os parâmetros atuais."""
        return {
            'taxa_multa': f"{self.taxa_multa:.2%}",
            'taxa_juros': f"{self.taxa_juros_mensal:.2%} ao mês"
        }
